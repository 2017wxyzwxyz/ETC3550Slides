---
title: "ETC3550 Applied&nbsp;forecasting&nbsp;for business&nbsp;and&nbsp;economics"
author: "Ch2. Time series graphics"
date: "OTexts.org/fpp3/"
toc: true
colortheme: monashwhite
output:
  binb::monash:
    fig_width: 7
    fig_height: 3.5
    includes:
      in_header: header.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
library(tidyverse)
library(fable)
library(tsibble)
library(feasts)
library(lubridate)
options(width=50)

ausbeer <- as_tsibble(fpp2::ausbeer) %>%
  rename(Time = index, Production = value)

elecsales <- as_tsibble(fpp2::elecsales) %>%
  rename(Year = index, GWh = value)

melsyd <- tsibbledata::ansett %>% 
  filter(Airports == "MEL-SYD")

a10 <- as_tsibble(fpp2::a10) %>%
    rename(Time = index, Scripts = value)

elecdaily <- as_tsibble(fpp2::elecdaily, gather = FALSE)

google_2015 <- tsibbledata::gafa_stock %>% 
  filter(Symbol == "GOOG", year(Date) == 2015)
```

# Time series in R

## `tsibble` objects

\fontsize{12}{13}\sf

A `tsibble` allows storage and manipulation of time series in R.

It contains:

- Measured variable(s): numbers of interest
- Key variable(s): unique identifiers for each series
- An index: time information about the observation

## `tsibble` objects

### Example

```{r tstable, cache=TRUE}
library(tsibble)
y <- tsibble(year = 2012:2016, 
  y = c(123,39,78,52,110), index = year)
print(y)
```

## Seasonal periods

\begin{tabular}{lrl}
\bf Type of data & \hspace*{1.95cm}\bf frequency                 & \bf start example\hspace*{0.25cm} \\
\midrule
Annual           & \only<2->{1}                                  & \only<3->{1995}\\
Quarterly        & \only<4->{4}                                  & \only<5->{c(1995,2)}\\
Monthly          & \only<6->{12}                                 & \only<7->{c(1995,9)}\\
Daily            & \only<8->{7 \emph{or} 365.25}                 & \only<9->{1 \emph{or} c(1995,234)} \\
Weekly           & \only<10->{52.18}                             & \only<11->{c(1995,23)}\\
Hourly           & \only<12->{24 \emph{or} 168 \emph{or} 8,766}  & \only<13->{1}\\
Half-hourly      & \only<14->{48 \emph{or} 336 \emph{or} 17,532} & \only<15>{1}
\end{tabular}

## Australian GDP

\fontsize{12}{14}\sf

```{r, echo = TRUE}
aus_economy <- global_economy %>% filter(Country == "Australia")
```

  * Object: "tsibble"
  * Print and plotting methods available.

```{r, echo=TRUE}
aus_economy
```

## Australian GDP

```{r, echo=TRUE, fig.height=4}
aus_economy %>% autoplot(GDP)
```

## Residential electricity sales

\fontsize{12}{14}\sf

```{r}
elecsales
```

## Class packages

```
library(tidyverse) # Data manipulation functions
library(fable) # Forecasting functions
library(feasts) # Time series graphics and statistics
library(tsibbledata) # Tidy time series data
library(fma) # Lots more time series data
```

# Time plots

## Time plots

\small

```{r, echo=TRUE, fig.height=4}
melsyd %>%
  filter(Class == "Economy.Class") %>%
  autoplot(Passengers)
```

## Time plots

\small

```{r a10, echo=TRUE}
a10 %>% autoplot(Scripts) + ylab("$ million") + xlab("Year") +
  ggtitle("Antidiabetic drug sales")
```

## Your turn

- Create plots of the following time series: `dole`, `bricksq`, `lynx`, `goog`
- Use `help()` to find out about the data in each series.
- For the last plot, modify the axis labels and title.

## Are time plots best?

\fontsize{12}{14}\sf

```{r maxtemp}
elecdaily %>%
  autoplot(Temperature) +
  xlab("Week") + ylab("Max temperature")
```

## Are time plots best?

\fontsize{12}{14}\sf

```{r maxtemp2, warning=FALSE, message=FALSE}
elecdaily %>%
  ggplot(aes(x = index, y = Temperature)) +
  geom_point() +
  xlab("Week") + ylab("Max temperature")
```

## Are time plots best?

```{r maxtemp3, warning=FALSE, message=FALSE, echo=FALSE}
elecdaily %>%
  ggplot(aes(x = index, y = 1)) +
  geom_tile(aes(fill = Temperature)) +
  scale_fill_gradient2(
    low = "navy",
    mid = "yellow",
   high = "red", midpoint=28) +
  ylab("") + scale_y_discrete(expand=c(0,0))
```

## Are time plots best?

\fullheight{TemperatureBlanket}

# Seasonal plots

## Seasonal plots

\footnotesize

```{r, echo=TRUE}
a10 %>% ggseasonplot(Scripts, labels = "both") +
  ylab("$ million") +
  ggtitle("Seasonal plot: antidiabetic drug sales")
```

## Seasonal plots

  * Data plotted against the individual "seasons" in which the data were observed.  (In this case a "season" is a month.)
  * Something like a time plot except that the data from each season are overlapped.
  * Enables the underlying seasonal pattern to be seen more clearly, and also allows any substantial departures from the seasonal pattern to be easily identified.
  * In R: `ggseasonplot()`

<!-- ## Seasonal polar plots -->

<!-- \small -->

<!-- ```{r, fig.height=6, out.width="7.5cm"} -->
<!-- a10 %>% ggseasonplot(polar = TRUE) + -->
<!--   ylab("$ million") -->
<!-- ``` -->

## Seasonal subseries plots

\small

```{r, echo=TRUE}
a10 %>% ggsubseriesplot(Scripts) + ylab("$ million") +
  ggtitle("Subseries plot: antidiabetic drug sales")
```

## Seasonal subseries plots

  * Data for each season collected together in time plot as separate time series.
  * Enables the underlying seasonal pattern to be seen clearly, and changes in seasonality over time to be visualized.
  * In R: `ggsubseriesplot()`

## Quarterly Australian Beer Production

```{r}
beer <- ausbeer %>%
  filter(year(Time) >= 1992)
beer %>% autoplot(Production)
```

## Quarterly Australian Beer Production

```{r}
beer %>% ggseasonplot(Production, labels="right")
```

## Quarterly Australian Beer Production

```{r}
beer %>% ggsubseriesplot(Production)
```

## Your turn

The `arrivals.csv` data set comprises quarterly international arrivals (in thousands) to Australia from Japan, New Zealand, UK and the US.

  - Use `autoplot()` and `ggseasonplot()` to compare the differences between the arrivals from these four countries.
  - Can you identify any unusual observations?

# Seasonal or cyclic?

## Time series patterns

Trend
  : pattern exists when there is a long-term increase or decrease in the data.

Seasonal
  : pattern exists when a series is influenced by seasonal factors (e.g., the quarter of the year, the month, or day of the week).

Cyclic
  : pattern exists when data exhibit rises and falls that are \emph{not of fixed period} (duration usually of at least 2 years).

## Time series components

### Differences between seasonal and cyclic patterns:

* seasonal pattern constant length; cyclic pattern variable length
* average length of cycle longer than length of seasonal pattern
* magnitude of cycle more variable than magnitude of seasonal pattern

## Time series patterns

\small

```{r}
as_tsibble(fma::elec) %>% filter(index >= 1980) %>%
  autoplot(value) +
  ggtitle("Australian electricity production") +
  xlab("Year") + ylab("GWh")
```

## Time series patterns

\small

```{r}
as_tsibble(fma::bricksq) %>%
  autoplot(value) +
  ggtitle("Australian clay brick production") +
  xlab("Year") + ylab("million units")
```

## Time series patterns

\small

```{r}
as_tsibble(fma::hsales) %>%
  autoplot(value) +
  ggtitle("Sales of new one-family houses, USA") +
  xlab("Year") + ylab("Total sales")
```

## Time series patterns

```{r}
as_tsibble(fma::ustreas) %>%
  autoplot(value) +
  ggtitle("US Treasury Bill Contracts") +
  xlab("Day") + ylab("price")
```

## Time series patterns
\small

```{r}
as_tsibble(lynx) %>%
  autoplot(value) +
  ggtitle("Annual Canadian Lynx Trappings") +
  xlab("Year") + ylab("Number trapped")
```

## Seasonal or cyclic?

\alert{Differences between seasonal and cyclic patterns:}

  * seasonal pattern constant length; cyclic pattern variable length
  * average length of cycle longer than length of seasonal pattern
  * magnitude of cycle more variable than magnitude of seasonal pattern

\pause

\begin{alertblock}{}
The timing of peaks and troughs is predictable with seasonal data, but unpredictable in the long term with cyclic data.
\end{alertblock}

# Lag plots and autocorrelation

## Example: Beer production

```r
beer <- ausbeer %>% filter(year(Time) >= 1992)
beer %>% gglagplot(Production)
```

## Example: Beer production

```{r, echo=FALSE, fig.height=6, fig.width=6, out.width="8cm"}
beer <- ausbeer %>% filter(year(Time) >= 1992)
beer %>% gglagplot(Production)
```

## Lagged scatterplots

  * Each graph shows $y_t$ plotted against $y_{t-k}$ for
different values of $k$.
  * The autocorrelations are the correlations associated
with these scatterplots.

## Autocorrelation

**Covariance** and **correlation**: measure extent of **linear relationship** between two variables ($y$ and $X$).\pause

**Autocovariance** and **autocorrelation**: measure linear relationship between **lagged values** of a time series $y$.\pause

We measure the relationship between:

  * $y_{t}$ and $y_{t-1}$
  * $y_{t}$ and $y_{t-2}$
  * $y_{t}$ and $y_{t-3}$
  * etc.

## Autocorrelation

We denote the sample autocovariance at lag $k$ by $c_k$ and the sample autocorrelation at lag $k$ by $r_k$.  Then define

\begin{block}{}
\begin{align*}
c_k &= \frac{1}{T}\sum_{t=k+1}^T (y_t-\bar{y})(y_{t-k}-\bar{y}) \\[0.cm]
\text{and}\qquad
r_{k} &= c_k/c_0
\end{align*}
\end{block}\pause\small

  * $r_1$ indicates how successive values of  $y$  relate to each other
  * $r_2$ indicates how  $y$ values two periods apart relate to each other
  * $r_k$ is \textit{almost} the same as the sample correlation between $y_t$ and $y_{t-k}$.

## Autocorrelation

\small
Results for first 9 lags for beer data:

\footnotesize

```{r, echo=FALSE}
beer %>% ACF(Production, lag_max = 4)
```

```{r beeracf, fig.height=2.5}
beer %>% ACF(Production) %>% autoplot
```

## Autocorrelation

  * $r_{4}$  higher than for the other lags. This is due to **the seasonal pattern in the data**: the peaks tend to be **4 quarters** apart and the troughs tend to be **2 quarters** apart.
  * $r_2$ is more negative than for the other lags because troughs tend to be 2 quarters behind peaks.
  * Together, the autocorrelations at lags 1, 2, \dots, make up the \emph{autocorrelation} or ACF.
  * The plot is known as a **correlogram**

## ACF

```{r, fig.height=4, echo=TRUE}
beer %>% ACF(Production) %>% autoplot
```

## Trend and seasonality in ACF plots

- When data have a trend, the autocorrelations for small lags tend to be large and positive.
- When data are seasonal, the autocorrelations will be larger at the seasonal lags (i.e., at multiples of the seasonal frequency)
- When data are trended and seasonal, you see a combination of these effects.

## Aus monthly electricity production

```{r}
elec2 <- as_tsibble(fma::elec) %>% filter(year(index) >= 1980)
elec2 %>% autoplot(value)
```

## Aus monthly electricity production

```{r}
elec2 %>% ACF(value, lag_max=48) %>% autoplot()
```

## Aus monthly electricity production

Time plot shows clear trend and seasonality.

The same features are reflected in the ACF.

  * The slowly decaying ACF indicates trend.
  * The ACF peaks at lags 12, 24, 36, \dots, indicate seasonality of length 12.

## Google stock price

```{r}
google_2015 %>% autoplot(Price)
```

## Google stock price

```{r}
google_2015 %>% ACF(Price, lag_max=100) %>% autoplot
```

## Your turn

We have introduced the following functions:

  - `gglagplot`
  - `ACF`

Explore the following time series using these functions. Can you spot any seasonality, cyclicity and trend? What do you learn about the series?

  - `hsales`
  - `usdeaths`
  - `bricksq`
  - `sunspotarea`
  - `gasoline`

## Which is which?

```{r, fig.height=6, fig.width=12, echo=FALSE, warning=FALSE, out.width="11.5cm"}
cowtemp <- as_tsibble(fma::cowtemp)
USAccDeaths <- as_tsibble(USAccDeaths)
AirPassengers <- as_tsibble(AirPassengers)
mink <- as_tsibble(fma::mink)
tp1 <- autoplot(cowtemp, value) + xlab("") + ylab("chirps per minute") +
  ggtitle("1. Daily temperature of cow")
tp2 <- autoplot(USAccDeaths, value) + xlab("") + ylab("thousands") +
  ggtitle("2. Monthly accidental deaths")
tp3 <- autoplot(AirPassengers, value) + xlab("") + ylab("thousands") +
  ggtitle("3. Monthly air passengers")
tp4 <- autoplot(mink, value) + xlab("") + ylab("thousands") +
  ggtitle("4. Annual mink trappings")
acfb <- ACF(cowtemp, value) %>% autoplot() + xlab("") + ggtitle("B") + ylim(-0.4,1)
acfa <- ACF(USAccDeaths, value) %>% autoplot() + xlab("") + ggtitle("A") + ylim(-0.4,1)
acfd <- ACF(AirPassengers, value) %>% autoplot() + xlab("") + ggtitle("D") + ylim(-0.4,1)
acfc <- ACF(mink, value) %>% autoplot() + xlab("") + ggtitle("C") + ylim(-0.4,1)
gridExtra::grid.arrange(tp1,tp2,tp3,tp4,
                        acfa,acfb,acfc,acfd,nrow=2)
```

# White noise

## Example: White noise

```{r}
wn <- tsibble(t = seq_len(36), y = rnorm(36), index = t)
wn %>% autoplot(y)
```

## Example: White noise

```{r, echo=FALSE}
wn %>% ACF(y, lag_max = 10)
```

```{r, echo=FALSE}
# Create nice R figures
savepdf <- function(file, width=16, height=10)
{
  fname <<- paste("figs/",file,".pdf",sep="")
  pdf(fname, width=width/2.54, height=height/2.54, pointsize=10)
  par(mgp=c(2.2,0.45,0), tcl=-0.4, mar=c(3.3,3.6,1.1,1.1))
}
endpdf <- function()
{
  crop::dev.off.crop(fname)
}
savepdf("wnacf")
wn %>% ACF(y) %>% autoplot
endpdf()
```

\placefig{4.5}{1.6}{width=8cm}{wnacf}

\centerline\textbf{Sample autocorrelations for white noise series.}

We expect each autocorrelation to be close to zero.

## \large Sampling distribution of autocorrelations

Sampling distribution of $r_k$ for white noise data is asymptotically N(0,$1/T$).\pause

  *  95% of all $r_k$ for white noise must lie within $\pm 1.96/\sqrt{T}$.
  * If this is not the case, the series is probably not WN.
  * Common to plot lines at $\pm 1.96/\sqrt{T}$ when plotting ACF.
These are the \textcolor{orange}{\textbf{\emph{critical values}}}.

## Autocorrelation

\placefig{5}{1.6}{width=8cm}{wnacf}

\begin{textblock}{4.8}(0.2,1.5)
\structure{Example:}

$T=36$ and so critical values at $\pm
1.96/\sqrt{36} = \pm 0.327$.

All autocorrelation coefficients lie within these
limits, confirming  that the data are white noise. (More precisely, the data cannot be \\
distinguished \rlap{from white noise.)}
\end{textblock}

## Example: Pigs slaughtered

\small

```{r, fig.height=3}
pigs2 <- as_tsibble(fma::pigs) %>% filter(year(index) >= 1990)
pigs2 %>% autoplot(value) +
  xlab("Year") + ylab("thousands") +
  ggtitle("Number of pigs slaughtered in Victoria")
```

## Example: Pigs slaughtered

```{r}
pigs2 %>% ACF(value) %>% autoplot()
```

## Example: Pigs slaughtered

Monthly total number of pigs slaughtered
in the state of Victoria, Australia, from January 1990 through August 1995.
(Source: Australian Bureau of Statistics.)\pause

  * Difficult to detect pattern in time plot.
  * ACF shows some significant autocorrelation at lags 1, 2, and 3.
  * $r_{12}$ relatively large although not significant.  This may indicate
some slight seasonality.

\pause

These show the series is **not a white noise series**.

## Your turn

You can compute the daily changes in the Google stock price using

```{r, eval = FALSE}
dgoog <- google_2015 %>%
  mutate(diff = difference(Close))
```

Does `dgoog` look like white noise?
